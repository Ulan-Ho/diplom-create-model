<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞—Ä—à—Ä—É—Ç—ã —Å OSRM</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="global.css">
</head>
<body>
    <div class="main_style flex-row">
        <div class="change_transport flex-col">
            <!-- <button id="car-button">üöó –ú–∞—à–∏–Ω–∞</button> -->
            <!-- <button id="bike-button">üö≤ –í–µ–ª–æ—Å–∏–ø–µ–¥</button>
            <button id="walk-button">üö∂ –ü–µ—à–∫–æ–º</button>
            <button id="truck-button">üöõ –ì—Ä—É–∑–æ–≤–∏–∫</button> -->
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: blue;"></div>
                    <span>–û—Å–Ω–æ–≤–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: green;"></div>
                    <span>–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç</span>
                </div>
            </div>
            <div class="mb-4">
                <label for="algorithm" class="block font-medium">–í—ã–±–µ—Ä–∏—Ç–µ –∞–ª–≥–æ—Ä–∏—Ç–º:</label>
                <select id="algorithm" class="border rounded w-full p-2">
                    <option value="dijkstra">–î–µ–π–∫—Å—Ç—Ä–∞</option>
                    <option value="astar">A*</option>
                    <option value="genetic">–ì–µ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º</option>
                </select>
            </div>
            <div class="mb-4">
                –°–∫–ª–∞–¥—ã
            </div>
        </div>

        <div style="position: relative; width: 100%; height: 100%;">
            <div class="points-panel">
                <div id="points_list">
                    <!-- –°–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                <div class="flex gap-2 mt-2 w-full">
                    <!-- <button class="action-btn" onclick="getRoute()">
                        &#128658; 
                    </button>
                    <button class="action-btn" onclick="addWaypointManually()">
                        &#43;
                    </button> -->
                    <div id="info"></div>
                </div>
            </div>
            <div id="map" class="map_style"></div>
            <script>
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
                const map = L.map('map').setView([43.23895, 76.92848], 13);

                // const map = L.map("map").setView([47.5, 67.0], 13); // –¶–µ–Ω—Ç—Ä–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞

// –ì—Ä–∞–Ω–∏—Ü—ã –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ (–ø—Ä–∏–º–µ—Ä–Ω–æ)
const kazakhstanPolygon = [
    [55.0, 73.0],  // –°–µ–≤–µ—Ä (–ü–µ—Ç—Ä–æ–ø–∞–≤–ª–æ–≤—Å–∫)
    [51.0, 87.0],  // –í–æ—Å—Ç–æ–∫ (–ö–∏—Ç–∞–π—Å–∫–∞—è –≥—Ä–∞–Ω–∏—Ü–∞)
    [42.0, 79.0],  // –Æ–≥–æ-–≤–æ—Å—Ç–æ–∫ (–ê–ª–º–∞—Ç—ã)
    [40.0, 69.0],  // –Æ–≥ (–®—ã–º–∫–µ–Ω—Ç)
    [47.0, 51.0],  // –ó–∞–ø–∞–¥ (–ê—Ç—ã—Ä–∞—É)
    [54.0, 50.0],  // –°–µ–≤–µ—Ä–æ-–∑–∞–ø–∞–¥ (–ö–æ—Å—Ç–∞–Ω–∞–π)
    [55.0, 73.0]   // –ó–∞–º–∫–Ω–µ–º –∫–æ–Ω—Ç—É—Ä
];

// –û—Ç–æ–±—Ä–∞–∑–∏–º –≥—Ä–∞–Ω–∏—Ü—ã –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞ –Ω–∞ –∫–∞—Ä—Ç–µ
L.polygon(kazakhstanPolygon, { color: "blue" }).addTo(map);

// –ì–µ–Ω–µ—Ä–∞—Ü–∏—è —Å–ª—É—á–∞–π–Ω–æ–π —Ç–æ—á–∫–∏ –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª–∏–≥–æ–Ω–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π –º–µ—Ç–æ–¥)
function getRandomLatLngInKazakhstan() {
    let lat, lng;
    do {
        lat = 40.5 + Math.random() * (54.5 - 40.5);
        lng = 50.5 + Math.random() * (86.5 - 50.5);
    } while (!insidePolygon([lat, lng], kazakhstanPolygon));
    
    return L.latLng(lat, lng);
}

// –§—É–Ω–∫—Ü–∏—è –¥–ª—è –ø—Ä–æ–≤–µ—Ä–∫–∏, –ª–µ–∂–∏—Ç –ª–∏ —Ç–æ—á–∫–∞ –≤–Ω—É—Ç—Ä–∏ –ø–æ–ª–∏–≥–æ–Ω–∞ (–∞–ª–≥–æ—Ä–∏—Ç–º "Ray-Casting")
function insidePolygon(point, polygon) {
    let [x, y] = point;
    let inside = false;
    for (let i = 0, j = polygon.length - 1; i < polygon.length; j = i++) {
        let [xi, yi] = polygon[i];
        let [xj, yj] = polygon[j];
        let intersect = yi > y !== yj > y && x < ((xj - xi) * (y - yi)) / (yj - yi) + xi;
        if (intersect) inside = !inside;
    }
    return inside;
}

// –§—É–Ω–∫—Ü–∏—è –∫–ª–∏–∫–∞ –≤ —Å–ª—É—á–∞–π–Ω–æ–π —Ç–æ—á–∫–µ –ö–∞–∑–∞—Ö—Å—Ç–∞–Ω–∞
function clickRandomPointInKazakhstan() {
    const randomLatLng = getRandomLatLngInKazakhstan();
    map.fire("click", { latlng: randomLatLng });
}

// –ó–∞–ø—É—Å–∫ —Å–ª—É—á–∞–π–Ω—ã—Ö –∫–ª–∏–∫–æ–≤ (—Ä–∞–∑ –≤ 2 —Å–µ–∫—É–Ω–¥—ã)
// setInterval(clickRandomPointInKazakhstan, 800);

            
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                }).addTo(map);
            
                // –û–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
                let startMarker, endMarker;
                let waypointMarkers = []; // –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ { marker, lat, lng }
                let routeLayers = [];
            
                // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –∏–∫–æ–Ω–∫–∏
                const createIcon = (color, label = '') => {
                return L.divIcon({
                    html: `<div style="background:${color}; width:24px; height:24px; border-radius:50%; border:2px solid #fff; text-align:center; line-height:24px; color:#fff; font-weight:bold;">${label}</div>`,
                    className: ''
                });
                };
            
                // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∫–æ–Ω–æ–∫ –¥–ª—è –≤—Å–µ—Ö —Ç–æ—á–µ–∫
                function updateMarkerIcons() {
                    if (startMarker) {
                        startMarker.setIcon(createIcon("green"));
                    }
                    // waypointMarkers.forEach((wp, index) => {
                    //     wp.marker.setIcon(createIcon("blue", index + 1));
                    // });
                    if (endMarker) {
                        endMarker.setIcon(createIcon("red"));
                    }
                }
            
                // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—Ç–æ–≤–æ–π –∏–ª–∏ –∫–æ–Ω–µ—á–Ω–æ–π —Ç–æ—á–∫–∏ —Å –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º
                function removePoint(type) {
                    if (type === 'start' && startMarker) {
                        map.removeLayer(startMarker);
                        startMarker = null;
                        // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏, –ø–µ—Ä–≤–∞—è —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–æ–≤—ã–º —Å—Ç–∞—Ä—Ç–æ–º
                        if (waypointMarkers.length > 0) {
                            const first = waypointMarkers.shift();
                            startMarker = first.marker;
                        }
                    }
                    if (type === 'end' && endMarker) {
                        map.removeLayer(endMarker);
                        endMarker = null;
                        // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏, –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–æ–≤—ã–º –∫–æ–Ω—Ü–æ–º
                        if (waypointMarkers.length > 0) {
                        const last = waypointMarkers.pop();
                        endMarker = last.marker;
                        }
                    }
                    // if (endMarker == null || startMarker == null ) {
                    //     clearRoutes();
                    // }
                    updatePointsPanel();
                    updateMarkerIcons();
                    getRoute(); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è/–ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
                }
            
                // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–π —Ç–æ—á–∫–∏
                function removeWaypoint(index) {
                    if (waypointMarkers[index]) {
                        map.removeLayer(waypointMarkers[index].marker);
                        waypointMarkers.splice(index, 1);
                    }
                    updatePointsPanel();
                    updateMarkerIcons();
                    getRoute();
                }
            
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ —Ç–æ—á–µ–∫
                function updatePointsPanel() {
                    const container = document.getElementById("points_list");
                    container.innerHTML = "";
                    // –ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞
                    if (startMarker) {
                        const li = document.createElement("div");
                        li.className = "point-item";
                        li.innerHTML = `<span>–ù–∞—á–∞–ª–æ: ${formatLatLng(startMarker.getLatLng())}</span>
                                        <button onclick="removePoint('start')">&#8722;</button>`;
                        container.appendChild(li);
                    }
                    // –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏
                    // waypointMarkers.forEach((wp, index) => {
                    //     const li = document.createElement("div");
                    //     li.className = "point-item";
                    //     li.innerHTML = `<span>–¢–æ—á–∫–∞ ${index + 1}: ${formatLatLng(wp.marker.getLatLng())}</span>
                    //                     <button onclick="removeWaypoint(${index})">&#8722;</button>`;
                    //     container.appendChild(li);
                    // });
                    // –ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞
                    if (endMarker) {
                        const li = document.createElement("div");
                        li.className = "point-item";
                        li.innerHTML = `<span>–ö–æ–Ω–µ—Ü: ${formatLatLng(endMarker.getLatLng())}</span>
                                        <button onclick="removePoint('end')">&#8722;</button>`;
                        container.appendChild(li);
                    }
                }
            
                function formatLatLng(latlng) {
                    return `${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`;
                }
            
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏
                map.on('click', function(e) {
                    const latlng = e.latlng;
                    if (!startMarker) {
                        startMarker = L.marker(latlng, { draggable: true, icon: createIcon("green") }).addTo(map);
                        startMarker.on('dragend', function() {
                            updatePointsPanel();
                            getRoute();
                        });
                    } else if (!endMarker) {
                        endMarker = L.marker(latlng, { draggable: true, icon: createIcon("red") }).addTo(map);
                        endMarker.on('dragend', function() {
                            updatePointsPanel();
                            getRoute();
                        });
                    } else {
                        // const index = waypointMarkers.length + 1;
                        // const marker = L.marker(latlng, { draggable: true, icon: createIcon("blue", index) }).addTo(map);
                        // marker.on('dragend', function() {
                        //     updatePointsPanel();
                        //     getRoute();
                        // });
                        // waypointMarkers.push({ marker, lat: latlng.lat, lng: latlng.lng });
                        map.removeLayer(startMarker);
                        startMarker = L.marker(latlng, { draggable: true, icon: createIcon("green") }).addTo(map);
                        startMarker.on('dragend', function() {
                            updatePointsPanel();
                            getRoute();
                        });
                        map.removeLayer(endMarker);

                        endMarker = null
                    }
                    updatePointsPanel();
                    updateMarkerIcons();
                    getRoute();
                });
            
                // –§—É–Ω–∫—Ü–∏—è —Ä—É—á–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–π —Ç–æ—á–∫–∏ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É"
                function addWaypointManually() {
                    const latlng = map.getCenter();
                    const index = waypointMarkers.length + 1;
                    const marker = L.marker(latlng, { draggable: true, icon: createIcon("blue", index) }).addTo(map);
                    marker.on('dragend', function() {
                        updatePointsPanel();
                        getRoute();
                    });
                    waypointMarkers.push({ marker, lat: latlng.lat, lng: latlng.lng });
                    updatePointsPanel();
                    updateMarkerIcons();
                    getRoute();
                }
                
                function formatTime(seconds) {
                    const minutes = Math.floor(seconds / 60);
                    return minutes > 0 ? `${minutes} –º–∏–Ω` : `${seconds} —Å–µ–∫`;
                }

                function formatSpeed(distance, duration) {
                    return duration > 0 ? (distance / duration * 3.6).toFixed(2) + " –∫–º/—á" : "N/A";
                }
                // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –º–∞—Ä—à—Ä—É—Ç–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞ (–ø—Ä–∏–º–µ—Ä)
                async function getRoute() {
                    if (!startMarker || !endMarker) return;
                    // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: —Å—Ç–∞—Ä—Ç; –≤—Å–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏; –∫–æ–Ω–µ—Ü
                    const startCoords = startMarker.getLatLng();
                    const endCoords = endMarker.getLatLng();
                    let coords = [];
                    coords.push(`${startCoords.lng},${startCoords.lat}`);
                    waypointMarkers.forEach(wp => {
                        const latlng = wp.marker.getLatLng();
                        coords.push(`${latlng.lng},${latlng.lat}`);
                    });
                    coords.push(`${endCoords.lng},${endCoords.lat}`);
                    
                    // –ü—Ä–∏–º–µ—Ä URL –∑–∞–ø—Ä–æ—Å–∞ –∫ API (–∞–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ –ø–æ–¥ —Å–≤–æ–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
                    console.log("coord" , coords.join(';'))
                    const url = `http://127.0.0.1:8000/route/?points=${coords.join(';')}&profiles=car&profiles=foot&alternatives=true`;
                    try {
                        const response = await fetch(url);
                        const data = await response.json();
                        // console.log(data["osrm-route"]);
                        // osrm_data = data["osrm-route"]
                        if (!data.routes || data.routes.length === 0) {
                            console.error("–û—à–∏–±–∫–∞: API –Ω–µ –≤–µ—Ä–Ω—É–ª –º–∞—Ä—à—Ä—É—Ç—ã.");
                            clearRoutes();
                            return;
                        }
                        clearRoutes();
                        const info = document.getElementById("info");
                        info.innerHTML = ""; // –û—á–∏—â–∞–µ–º –ø–µ—Ä–µ–¥ –¥–æ–±–∞–≤–ª–µ–Ω–∏–µ–º –Ω–æ–≤—ã—Ö –¥–∞–Ω–Ω—ã—Ö

                        data.routes.forEach((route, index) => {
                            if (!route) return;

                            const routeCoords = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                            const color = index === 0 ? 'blue' : 'green';
                            const routeLayer = L.polyline(routeCoords, { color, weight: 4, opacity: 0.7 }).addTo(map);
                            routeLayers.push(routeLayer);
                           
                            // –°–æ–∑–¥–∞–µ–º –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä –¥–ª—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏–∏ –æ –∫–∞–∂–¥–æ–º –º–∞—Ä—à—Ä—É—Ç–µ
                            const routeInfo = document.createElement("div");
                            routeInfo.classList.add("route-info");

                            // –ó–∞–≥–æ–ª–æ–≤–æ–∫
                            const title = document.createElement("h3");
                            title.textContent = `–ú–∞—Ä—à—Ä—É—Ç ${index + 1}`;
                            routeInfo.appendChild(title);

                            // –û—Å–Ω–æ–≤–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è
                            const summary = document.createElement("p");
                            summary.innerHTML = `<strong>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</strong> ${(route.distance / 1000).toFixed(2)} –∫–º<br>
                                                <strong>–í—Ä–µ–º—è –≤ –ø—É—Ç–∏:</strong> ${(route.duration / 60).toFixed(2)} –º–∏–Ω—É—Ç<br>
                                                <strong>–°—Ä–µ–¥–Ω—è—è —Å–∫–æ—Ä–æ—Å—Ç—å:</strong> ${((route.distance / route.duration) * 3.6).toFixed(2)} –∫–º/—á<br>
                                                <strong>–ö–æ–ª–∏—á–µ—Å—Ç–≤–æ —ç—Ç–∞–ø–æ–≤:</strong> ${route.legs.length}`;
                            routeInfo.appendChild(summary);

                            // –î–µ—Ç–∞–ª—å–Ω–∞—è –∏–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —ç—Ç–∞–ø–∞–º –º–∞—Ä—à—Ä—É—Ç–∞
                            route.legs.forEach((leg, legIndex) => {
                                const legInfo = document.createElement("div");
                                legInfo.classList.add("leg-info");

                                const legTitle = document.createElement("h4");
                                legTitle.textContent = `–≠—Ç–∞–ø ${legIndex + 1}`;
                                legInfo.appendChild(legTitle);

                                const legDetails = document.createElement("p");
                                legDetails.innerHTML = `<strong>–†–∞—Å—Å—Ç–æ—è–Ω–∏–µ:</strong> ${(leg.distance / 1000).toFixed(2)} –∫–º<br>
                                                        <strong>–í—Ä–µ–º—è:</strong> ${(leg.duration / 60).toFixed(2)} –º–∏–Ω—É—Ç<br>
                                                        <strong>–®–∞–≥–æ–≤ –≤ —ç—Ç–∞–ø–µ:</strong> ${leg.steps.length}`;
                                legInfo.appendChild(legDetails);

                                // –î–µ—Ç–∞–ª–∏ —à–∞–≥–æ–≤
                                const stepsList = document.createElement("ul");
                                leg.steps.forEach((step, stepIndex) => {
                                    const stepItem = document.createElement("li");
                                    stepItem.textContent = step.distance != 0 && step.duration !=0 ? `–®–∞–≥ ${stepIndex + 1}: ${step.name || ''} ${step.maneuver["modifier"]} ${step.distance} –º, ${step.duration} —Å–µ–∫—É–Ω–¥, —Å–∫–æ—Ä–æ—Å—Ç—å ${formatSpeed(step.distance, step.duration)}` : `–®–∞–≥ ${stepIndex + 1}: –í—ã –ø—Ä–∏–±—ã–ª–∏ –Ω–∞ –º–µ—Å—Ç–æ!`;
                                    stepsList.appendChild(stepItem);
                                });

                                legInfo.appendChild(stepsList);
                                routeInfo.appendChild(legInfo);
                            });

                            info.appendChild(routeInfo);
                        });

                    } catch (error) {
                        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –º–∞—Ä—à—Ä—É—Ç–∞:", error);
                    }
                }
            
                function clearRoutes() {
                    routeLayers.forEach(layer => map.removeLayer(layer));
                    routeLayers = [];
                }


                
            </script>
        </div>
    </div>
</body>
</html>
