<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>–ú–∞—Ä—à—Ä—É—Ç—ã —Å OSRM</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/tailwindcss@2.2.19/dist/tailwind.min.css">
    <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
    <link rel="stylesheet" href="global.css">
</head>
<body>
    <div class="main_style flex-row">
        <div class="change_transport flex-col">
            <!-- <button id="car-button">üöó –ú–∞—à–∏–Ω–∞</button> -->
            <!-- <button id="bike-button">üö≤ –í–µ–ª–æ—Å–∏–ø–µ–¥</button>
            <button id="walk-button">üö∂ –ü–µ—à–∫–æ–º</button>
            <button id="truck-button">üöõ –ì—Ä—É–∑–æ–≤–∏–∫</button> -->
            <div class="legend">
                <div class="legend-item">
                    <div class="legend-color" style="background-color: blue;"></div>
                    <span>–û—Å–Ω–æ–≤–Ω–æ–π –º–∞—Ä—à—Ä—É—Ç</span>
                </div>
                <div class="legend-item">
                    <div class="legend-color" style="background-color: green;"></div>
                    <span>–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ã–π –º–∞—Ä—à—Ä—É—Ç</span>
                </div>
            </div>
            <div class="mb-4">
                <label for="algorithm" class="block font-medium">–í—ã–±–µ—Ä–∏—Ç–µ –∞–ª–≥–æ—Ä–∏—Ç–º:</label>
                <select id="algorithm" class="border rounded w-full p-2">
                    <option value="dijkstra">–î–µ–π–∫—Å—Ç—Ä–∞</option>
                    <option value="astar">A*</option>
                    <option value="genetic">–ì–µ–Ω–µ—Ç–∏—á–µ—Å–∫–∏–π –∞–ª–≥–æ—Ä–∏—Ç–º</option>
                </select>
            </div>
            <div class="mb-4">
                –°–∫–ª–∞–¥—ã
            </div>
        </div>

        <div style="position: relative; width: 100%; height: 100%;">
            <div class="points-panel">
                <div id="points_list">
                  <!-- –°–ø–∏—Å–æ–∫ —Ç–æ—á–µ–∫ –±—É–¥–µ—Ç –æ–±–Ω–æ–≤–ª—è—Ç—å—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ -->
                </div>
                <div class="flex gap-2 mt-2 w-full">
                    <button class="action-btn" onclick="getRoute()">
                        &#128658; <!-- &#128658; –ü–æ—Å—Ç—Ä–æ–∏—Ç—å –º–∞—Ä—à—Ä—É—Ç -->
                    </button>
                    <button class="action-btn" onclick="addWaypointManually()">
                        &#43;<!-- &#43; –î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É -->
                    </button>
                </div>
            </div>
            <div id="map" class="map_style"></div>
            <script>
                // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∫–∞—Ä—Ç—ã
                const map = L.map('map').setView([43.23895, 76.92848], 13);
            
                L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                    maxZoom: 18,
                }).addTo(map);
            
                // –û–±—ä—è–≤–ª–µ–Ω–∏–µ –ø–µ—Ä–µ–º–µ–Ω–Ω—ã—Ö
                let startMarker, endMarker;
                let waypointMarkers = []; // –º–∞—Å—Å–∏–≤ –æ–±—ä–µ–∫—Ç–æ–≤ { marker, lat, lng }
                let routeLayers = [];
            
                // –§—É–Ω–∫—Ü–∏—è —Å–æ–∑–¥–∞–Ω–∏—è –∫–∞—Å—Ç–æ–º–Ω–æ–π –∏–∫–æ–Ω–∫–∏
                const createIcon = (color, label = '') => {
                return L.divIcon({
                    html: `<div style="background:${color}; width:24px; height:24px; border-radius:50%; border:2px solid #fff; text-align:center; line-height:24px; color:#fff; font-weight:bold;">${label}</div>`,
                    className: ''
                });
                };
            
                // –§—É–Ω–∫—Ü–∏—è –æ–±–Ω–æ–≤–ª–µ–Ω–∏—è –∏–∫–æ–Ω–æ–∫ –¥–ª—è –≤—Å–µ—Ö —Ç–æ—á–µ–∫
                function updateMarkerIcons() {
                    if (startMarker) {
                        startMarker.setIcon(createIcon("green"));
                    }
                    waypointMarkers.forEach((wp, index) => {
                        wp.marker.setIcon(createIcon("blue", index + 1));
                    });
                    if (endMarker) {
                        endMarker.setIcon(createIcon("red"));
                    }
                }
            
                // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è —Å—Ç–∞—Ä—Ç–æ–≤–æ–π –∏–ª–∏ –∫–æ–Ω–µ—á–Ω–æ–π —Ç–æ—á–∫–∏ —Å –ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏–µ–º
                function removePoint(type) {
                    if (type === 'start' && startMarker) {
                        map.removeLayer(startMarker);
                        startMarker = null;
                        // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏, –ø–µ—Ä–≤–∞—è —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–æ–≤—ã–º —Å—Ç–∞—Ä—Ç–æ–º
                        if (waypointMarkers.length > 0) {
                        const first = waypointMarkers.shift();
                        startMarker = first.marker;
                        }
                    }
                    if (type === 'end' && endMarker) {
                        map.removeLayer(endMarker);
                        endMarker = null;
                        // –ï—Å–ª–∏ –µ—Å—Ç—å –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏, –ø–æ—Å–ª–µ–¥–Ω—è—è —Å—Ç–∞–Ω–æ–≤–∏—Ç—Å—è –Ω–æ–≤—ã–º –∫–æ–Ω—Ü–æ–º
                        if (waypointMarkers.length > 0) {
                        const last = waypointMarkers.pop();
                        endMarker = last.marker;
                        }
                    }
                    // if (endMarker == null || startMarker == null ) {
                    //     clearRoutes();
                    // }
                    updatePointsPanel();
                    updateMarkerIcons();
                    getRoute(); // –ü–µ—Ä–µ—Å—á–∏—Ç—ã–≤–∞–µ–º –º–∞—Ä—à—Ä—É—Ç –ø–æ—Å–ª–µ —É–¥–∞–ª–µ–Ω–∏—è/–ø–µ—Ä–µ–Ω–∞–∑–Ω–∞—á–µ–Ω–∏—è
                }
            
                // –§—É–Ω–∫—Ü–∏—è —É–¥–∞–ª–µ–Ω–∏—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–π —Ç–æ—á–∫–∏
                function removeWaypoint(index) {
                    if (waypointMarkers[index]) {
                        map.removeLayer(waypointMarkers[index].marker);
                        waypointMarkers.splice(index, 1);
                    }
                    updatePointsPanel();
                    updateMarkerIcons();
                    getRoute();
                }
            
                // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø–∞–Ω–µ–ª–∏ —Ç–æ—á–µ–∫
                function updatePointsPanel() {
                const container = document.getElementById("points_list");
                container.innerHTML = "";
                // –ù–∞—á–∞–ª—å–Ω–∞—è —Ç–æ—á–∫–∞
                if (startMarker) {
                    const li = document.createElement("div");
                    li.className = "point-item";
                    li.innerHTML = `<span>–ù–∞—á–∞–ª–æ: ${formatLatLng(startMarker.getLatLng())}</span>
                                    <button onclick="removePoint('start')">&#8722;</button>`;
                    container.appendChild(li);
                }
                // –ü—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏
                waypointMarkers.forEach((wp, index) => {
                    const li = document.createElement("div");
                    li.className = "point-item";
                    li.innerHTML = `<span>–¢–æ—á–∫–∞ ${index + 1}: ${formatLatLng(wp.marker.getLatLng())}</span>
                                    <button onclick="removeWaypoint(${index})">&#8722;</button>`;
                    container.appendChild(li);
                });
                // –ö–æ–Ω–µ—á–Ω–∞—è —Ç–æ—á–∫–∞
                if (endMarker) {
                    const li = document.createElement("div");
                    li.className = "point-item";
                    li.innerHTML = `<span>–ö–æ–Ω–µ—Ü: ${formatLatLng(endMarker.getLatLng())}</span>
                                    <button onclick="removePoint('end')">&#8722;</button>`;
                    container.appendChild(li);
                }
                }
            
                function formatLatLng(latlng) {
                    return `${latlng.lat.toFixed(4)}, ${latlng.lng.toFixed(4)}`;
                }
            
                // –û–±—Ä–∞–±–æ—Ç—á–∏–∫ –∫–ª–∏–∫–∞ –ø–æ –∫–∞—Ä—Ç–µ –¥–ª—è –¥–æ–±–∞–≤–ª–µ–Ω–∏—è —Ç–æ—á–∫–∏
                map.on('click', function(e) {
                    const latlng = e.latlng;
                    if (!startMarker) {
                        startMarker = L.marker(latlng, { draggable: true, icon: createIcon("green") }).addTo(map);
                        startMarker.on('dragend', function() {
                        updatePointsPanel();
                        getRoute();
                        });
                    } else if (!endMarker) {
                        endMarker = L.marker(latlng, { draggable: true, icon: createIcon("red") }).addTo(map);
                        endMarker.on('dragend', function() {
                        updatePointsPanel();
                        getRoute();
                        });
                    } else {
                        const index = waypointMarkers.length + 1;
                        const marker = L.marker(latlng, { draggable: true, icon: createIcon("blue", index) }).addTo(map);
                        marker.on('dragend', function() {
                        updatePointsPanel();
                        getRoute();
                        });
                        waypointMarkers.push({ marker, lat: latlng.lat, lng: latlng.lng });
                    }
                    updatePointsPanel();
                    updateMarkerIcons();
                    getRoute();
                });
            
                // –§—É–Ω–∫—Ü–∏—è —Ä—É—á–Ω–æ–≥–æ –¥–æ–±–∞–≤–ª–µ–Ω–∏—è –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω–æ–π —Ç–æ—á–∫–∏ —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É "–î–æ–±–∞–≤–∏—Ç—å —Ç–æ—á–∫—É"
                function addWaypointManually() {
                    const latlng = map.getCenter();
                    const index = waypointMarkers.length + 1;
                    const marker = L.marker(latlng, { draggable: true, icon: createIcon("blue", index) }).addTo(map);
                    marker.on('dragend', function() {
                        updatePointsPanel();
                        getRoute();
                    });
                    waypointMarkers.push({ marker, lat: latlng.lat, lng: latlng.lng });
                    updatePointsPanel();
                    updateMarkerIcons();
                    getRoute();
                }
            
                // –§—É–Ω–∫—Ü–∏—è –∑–∞–ø—Ä–æ—Å–∞ –º–∞—Ä—à—Ä—É—Ç–∞ —Å —Å–µ—Ä–≤–µ—Ä–∞ (–ø—Ä–∏–º–µ—Ä)
                async function getRoute() {
                    if (!startMarker || !endMarker) return;
                    // –°–æ–±–∏—Ä–∞–µ–º –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã: —Å—Ç–∞—Ä—Ç; –≤—Å–µ –ø—Ä–æ–º–µ–∂—É—Ç–æ—á–Ω—ã–µ —Ç–æ—á–∫–∏; –∫–æ–Ω–µ—Ü
                    const startCoords = startMarker.getLatLng();
                    const endCoords = endMarker.getLatLng();
                    let coords = [];
                    coords.push(`${startCoords.lng},${startCoords.lat}`);
                    waypointMarkers.forEach(wp => {
                        const latlng = wp.marker.getLatLng();
                        coords.push(`${latlng.lng},${latlng.lat}`);
                    });
                    coords.push(`${endCoords.lng},${endCoords.lat}`);
                    
                    // –ü—Ä–∏–º–µ—Ä URL –∑–∞–ø—Ä–æ—Å–∞ –∫ API (–∞–¥–∞–ø—Ç–∏—Ä—É–π—Ç–µ –ø–æ–¥ —Å–≤–æ–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã)
                    console.log("coord" , coords.join(';'))
                    const url = `http://127.0.0.1:8000/route/?points=${coords.join(';')}&profiles=car&profiles=foot&alternatives=true`;
                    try {
                        const response = await fetch(url);
                        const data = await response.json();
                        console.log(data);
                        if (!data.routes || data.routes.length === 0) {
                        console.error("–û—à–∏–±–∫–∞: API –Ω–µ –≤–µ—Ä–Ω—É–ª –º–∞—Ä—à—Ä—É—Ç—ã.");
                        clearRoutes();
                        return;
                        }
                        clearRoutes();
                        data.routes.forEach((route, index) => {
                            console.log("Start route");
                            const routeCoords = route.geometry.coordinates.map(coord => [coord[1], coord[0]]);
                            const color = index === 0 ? 'blue' : 'green';
                            const routeLayer = L.polyline(routeCoords, { color, weight: 4, opacity: 0.7 }).addTo(map);
                            routeLayers.push(routeLayer);
                        });
                    } catch (error) {
                        console.error("–û—à–∏–±–∫–∞ –∑–∞–ø—Ä–æ—Å–∞ –º–∞—Ä—à—Ä—É—Ç–∞:", error);
                    }
                }
            
                function clearRoutes() {
                    routeLayers.forEach(layer => map.removeLayer(layer));
                    routeLayers = [];
                }
            </script>
        </div>
    </div>
</body>
</html>
